#!/usr/bin/env bash
# shellcheck disable=SC2086

# `cargo-docserve`: Live refreshing Cargo documentation.
# Source: https://benjamincongdon.me/blog/2018/08/22/Live-Refreshing-Cargo-Docs/

if ! type cargo-watch > /dev/null; then
  echo "! \`cargo-watch\` is not installed!"
  echo "! Run \`cargo install cargo-watch\` to install."
  exit 1
fi

if ! type browser-sync > /dev/null; then
  echo "! \`browser-sync\` is not installed!"
  echo "! Run \`npm install -g browser-sync\` to install."
  exit 1
fi

if ! type jq > /dev/null; then
  echo "! \`jq\` is not installed!"
  echo "! Install \`jq\` following the instructions at https://stedolan.github.io/jq/."
fi

browser-sync start --no-open --server target/doc --serveStatic target/doc --files target/doc --directory ${BROWSER_SYNC_ARGS} &
cargo-watch ${CARGO_WATCH_ARGS} -s "cargo doc ${CARGO_DOC_ARGS}" &
sleep 5 && xdg-open "http://localhost:3000/$(cargo read-manifest | jq -r '.targets[0].name' | sed -e 's:-:_:g')"
